##
#### Configuration file for the report generator
##
## - Variables starts with '$', and comments with '#'.
## - Values must be within double quates (") and lines must end with a semicolon (;).
## - $sql is the sql-query. Line break and white space is allowed.
## - $order_by defines the default ordering of the sql query. By clicking on the
##   column headers
##   in the report, you can sort/reverse sort on other criteria.
## - $title ($overskrift) is the report title as shown on web.
## - $extra ($ekstra) are extra columns that can be used for hyperlinks (see $url).
## - $hide ($skjul) are columns that must be included in the $sql because they
##   are used in a $url, see below. $hide will not show the column in the report.
## - $sum shows the total of a given column (may not work...).
## - $count angir kolonner som skal telles.
## - $name_MYCOL ($navn_MYCOL) changes the column header.
## - $url_MYCOL makes a hyperlink
## - $explain_MYCOL ($forklar_MYCOL) shows an explaination as popup in the
##   browser when you hold the curser over the column header.
## - $description is the descriptive summary of what the report shows.
##
##

# ---------------------------------------------------------------------
# netbox related reports
#

netbox {
$description = "An overview of all IP devices.";
$sql="
SELECT roomid,sysname,ip,catid,sub,typeid,typename,vendorid,
       orgid,netbox.up,modules,swport,gwport, prefixcount,
       CASE WHEN Mem THEN 'Mem' ELSE NULL END AS Mem,snmp,
       sw_ver AS Software,serial,val AS Function,netbox.netboxid,
       netboxprefix.prefixid
       FROM type
       RIGHT OUTER JOIN netbox USING (typeid)
       LEFT JOIN netboxprefix USING (netboxid)
       LEFT JOIN (SELECT netboxid,count(distinct interfaceid) AS gwport, count(prefixid) AS prefixcount
                       FROM interface JOIN gwportprefix USING (interfaceid)
                       GROUP BY netboxid) tempaggr1 USING (netboxid)
       LEFT JOIN (SELECT netboxid,count(interfaceid) AS swport
                       FROM interface_swport
                       GROUP BY netboxid) tempaggr2 USING (netboxid)
       LEFT JOIN (SELECT netboxid,count(netboxid) AS modules
                       FROM module
                       GROUP BY netboxid) tempaggr3 USING (netboxid)
       LEFT JOIN (SELECT netboxid,count(netboxid) AS sub
                       FROM netboxcategory
                       GROUP BY netboxid) tempaggr4 USING (netboxid)
       LEFT JOIN (SELECT netboxid,count(netboxid) AS snmp
                       FROM netboxsnmpoid 
                       GROUP BY netboxid) tempaggr5 USING (netboxid)
       LEFT JOIN (SELECT netboxid, count(netboxid) > 0 AS Mem
                       FROM mem
                       GROUP by netboxid) tempaggr6 USING (netboxid)
       LEFT JOIN device ON (netbox.deviceid=device.deviceid)
       LEFT JOIN netboxinfo ON (netbox.netboxid=netboxinfo.netboxid 
                                AND var='function')
";
$hide = "netboxid,prefixid,typeid,vendorid";
$order_by="roomid";
$title = "Devices in Operation";
$name_sysname="Name";
$name_catid="Cat";
$name_ip="IP address";
$name_typename="Type";
$name_roomid="Room";
$name_orgid="Org";
$name_up="Up";
$name_modules="#mod";
$name_swport="#swp";
$name_gwport="#gwp";
$name_prefixcount="#prefixes";
$url_roomid="room?roomid=$roomid";
$url_sysname="/ipdevinfo/$sysname";
$url_typename="type?typeid=$typeid";
$url_orgid="org?orgid=$orgid";
$url_catid="netbox?catid=$catid";
$url_sub="netboxinfo?netboxid=$netboxid";
$url_modules="modules?sysname=$sysname";
$url_Mem="mem?sysname=$sysname";
$url_swport="swport?netboxid=$netboxid";
$url_gwport="gwport?netboxid=$netboxid";
$url_up="/status/history/?type=boxes&id=$netboxid";
$url_Function="netbox?val=$Function";
$url_snmp="netboxsnmpoid?netboxid=$netboxid";
$url_prefixcount="gwip?sysname=$sysname";
$explain_Mem="Memory";
$explain_swp="Switch Ports";
$explain_gwp="Router Ports";
$explain_up="Status";
$explain_snmp="#SNMP OIDs classified";
$explain_sub="Sub category"; 
$sum="swport";
}


netboxinfo {
$description = "Simple info about a netbox.";
$sql="SELECT roomid,sysname,catid,category AS subcat,netboxid 
      FROM netbox 
      LEFT JOIN netboxcategory USING (netboxid)":
$title="Netboxinfo";
$hide="netboxid";
$url_subcat="netboxinfo?category=$subcat";
}


uptime {
$description = "Netboxes uptime listed descending.";
$sql="
SELECT roomid,sysname,host(ip),catid,typeid,typename,prefixid,upsince,now()-upsince as uptime
FROM netbox
JOIN type USING (typeid)
LEFT JOIN netboxprefix USING (netboxid)
";
$title="Uptime";
$hide="typeid,prefixid";
$name_catid="Category";
$name_typename="Type";
$name_roomid="Room";
$name_sysname="Name";
$order_by="upsince desc";
$url_roomid="room?roomid=$roomid";
$url_sysname="/ipdevinfo/$sysname";
$url_typename="type?typeid=$typeid";
$url_orgid="org?orgid=$orgid";
$url_ip="prefix?prefixid=$prefixid"; 
$url_catid="netbox?catid=$catid";
}


srv {
$description = "Shows servers beeing monitored and related information.";
$sql = "
 SELECT roomid,sysname,host(ip),catid,orgid, count(distinct category) as subcats,
        count(serviceid) as services, val as function, netbox.netboxid, netboxprefix.prefixid 
 FROM netbox 
 LEFT JOIN netboxprefix USING (netboxid)
 LEFT JOIN service USING (netboxid) 
 LEFT JOIN netboxcategory USING (netboxid) 
 LEFT JOIN netboxinfo ON (netboxinfo.netboxid=netbox.netboxid AND netboxinfo.var='function') 
 WHERE catid='SRV' 
 GROUP BY roomid,sysname,host(ip),catid,orgid,val,netbox.netboxid,netbox.ip,prefixid";
$title = "Servers";
$name_sysname="Name";
$url_sysname="/ipdevinfo/$sysname";
$name_ip="IP";
$name_orgid="Org";
$name_roomid="Room";
$order_by="roomid";
$hide = "netboxid,prefixid";          
$url_subcats="netboxinfo?netboxid=$netboxid";
$url_ip="prefix?prefixid=$prefixid";
$url_roomid="room?roomid=$roomid";
$url_typeid="type?typeid=$typeid";
$url_orgid="org?orgid=$orgid";
$url_services="servicemon?netboxid=$netboxid";
$url_function="netbox?val=$function";
$url_catid="netbox?catid=$catid";
}


servicemon {
$description = "Shows services beeing monitored and related information.";
$sql="
  SELECT sysname,handler,version,netboxid 
  FROM service 
  LEFT JOIN netbox USING (netboxid)";
$title="Services being monitored";
$name_orgid="Owner";
$hide="netboxid";
$url_sysname="srv?sysname=$sysname";
}
 

device {
$description = "Shows information about devices.";
$sql = "
 (SELECT
    serial, roomid, sysname,
    CASE module.name
      WHEN NULL THEN 'N/A'
      WHEN '' THEN 'N/A'
      ELSE module.name
    END AS module,
    module.moduleid
  FROM device
  JOIN module USING (deviceid)
  JOIN netbox USING (netboxid)
 ) UNION
 (SELECT
    serial, roomid, sysname, NULL as module, NULL as moduleid
  FROM device
  JOIN netbox USING (deviceid)
 )
";
$title = "Devices";
$hide = "moduleid";
$name_roomid="Room";
$name_serial="Serial Number";
$name_sysname="Netbox";
$name_module="Module";
$order_by="roomid,sysname,module,serial";
$url_roomid="room?roomid=$roomid";
$url_sysname="netbox?sysname=$sysname";
$url_module="modules?moduleid=$moduleid";
}


modules {
$description = "A overview of modules on netboxes.";
$sql="
 SELECT 
   netboxid,
   typeid,
   roomid,
   sysname,
   moduleid,
   module.name AS mn,
   swport,
   gwport,
   model,
   descr,
   serial,
   sw_ver AS Software,
   hw_ver AS Hardware,
   fw_ver AS Firmware
 FROM netbox 
 JOIN module USING (netboxid) 
 JOIN device ON module.deviceid=device.deviceid
 LEFT JOIN (SELECT moduleid,count(interfaceid) AS gwport
                 FROM interface_gwport
                 GROUP BY moduleid) tempaggr1 USING (moduleid)
 LEFT JOIN (SELECT moduleid,count(interfaceid) AS swport
                 FROM interface_swport
                 GROUP BY moduleid) tempaggr2 USING (moduleid)
";
$title = "Modules";
$order_by="roomid,sysname,mn";
$hide = "netboxid,typeid,moduleid";
$name_swport="#swp";
$name_gwport="#gwp";
$url_roomid="room?roomid=$roomid";
$url_sysname="netbox?sysname=$sysname";
$url_swport="swport?sysname=$sysname&module=$mn";
$url_gwport="gwport?sysname=$sysname&module=$mn";
$url_model="modules?model=$model";
$explain_mn="Module number";
}


mem {
$description = "Memory status on netboxes.";
$sql="
 SELECT sysname,catid,typename,memtype,device,to_char(size,'999G999G999G999') AS size,
  to_char(used,'999G999G999G999') AS used,
  to_char(size-used,'999G999G999G999') AS free,
  TO_CHAR((used/(size+0.0001))*100, '999')::int AS used_pst 
 FROM netbox JOIN mem USING (netboxid) 
 LEFT JOIN type USING (typeid)";
$order_by="sysname,catid,memtype,device";
$title = "Memory";
$name_used_pst = "used %"
$url_sysname="netbox?sysname=$sysname";
$url_memtype="mem?memtype=$memtype";
$url_device="mem?device=$device";
$url_typename="type?typename=$typename";
}


# ---------------------------------------------------------------------
# router port / prefix - related reports
#

gwport {
$description = "Extended information about router ports.";
$sql= "
 SELECT 
   netbox.sysname,
   interface.ifindex,
   interface.ifname as interface,
   module.module as moduleno,
   module.name as module,
   interface.link,
   interface.speed,
   prefixcount,
   netbox.netboxid,
   interface.interfaceid,
   interface.ifalias AS alias,
   n2.sysname AS otherbox,
   i2.ifname AS remoteif
 FROM 
   interface_gwport AS interface
 JOIN 
   netbox USING (netboxid)
 JOIN 
   (SELECT interfaceid, COUNT(prefixid) AS prefixcount
    FROM gwportprefix
    GROUP BY interfaceid) tempaggr1 USING (interfaceid)
 LEFT JOIN 
   module USING (moduleid)
 LEFT JOIN 
   netbox AS n2 ON (interface.to_netboxid=n2.netboxid)
 LEFT JOIN 
   interface AS i2 ON (interface.to_interfaceid=i2.interfaceid)
";
$title = "Router ports";
$hide = "netboxid,interfaceid,moduleno";
$name_sysname="Router";
$name_interface="Interface";
$name_gwip="IP address";
$name_speed="Mbps";
$name_portname="Description";
$name_prefixcount="#prefix";
$name_otherbox="Connected to";
$name_remoteif="Remote if";
$order_by="sysname,ifindex";
$url_sysname="netbox?sysname=$sysname";
$url_module="modules?sysname=$sysname&module=$module";
$url_prefixcount="gwip?sysname=$sysname&ifindex=$ifindex";
$url_otherbox="netbox?sysname=$otherbox";
$url_remoteif="swport?sysname=$otherbox&interface=$remoteif";
}


gwip {
$description = "Router port prefixes and related information.";
$sql= "
 SELECT 
   sysname,
   ifindex,
   ifname AS interface,
   module.name AS module,
   speed,
   CASE
     WHEN hsrp THEN 'Y' 
     ELSE NULL 
   END AS hsrp,
   gwip,
   netaddr AS prefix,
   vlan.vlanid,
   vlan.vlan,
   nettype,
   netident,
   ifalias AS Description,
   interface.netboxid,
   prefix.prefixid
 FROM 
   interface
 JOIN
   gwportprefix USING (interfaceid) 
 JOIN
   prefix ON (gwportprefix.prefixid=prefix.prefixid)
 JOIN
   netbox USING (netboxid)
 LEFT JOIN 
   module USING (moduleid)
 LEFT JOIN 
   vlan USING (vlanid)
 WHERE netbox.catid IN ('GW', 'GSW')
";
$title = "Router port prefixes";
$hide = "netboxid,prefixid,vlanid";
$name_sysname="Router";
$name_interface="Router port";
$name_gwip="IP address";
$name_speed="Mbps";
$order_by="sysname,ifindex,gwip";
$url_prefix="prefix?prefixid=$prefixid";
$url_sysname="netbox?sysname=$sysname";
$url_vlan="swporttrunk?vlan=$vlan";
$url_module="modules?sysname=$sysname&module=$module";
$url_interface="gwip?sysname=$sysname&ifindex=$ifindex";
}


prefix {
$description = "Detailed information about IP ranges/prefixes.";
$sql="
SELECT host(netaddr) AS netaddr,
       host(netaddr)::inet AS Network,
       masklen(netaddr::inet) AS m,
       CASE family(netaddr::inet) 
         WHEN 6 THEN 'IPv6'
         WHEN 4 THEN 'IPv4'
       END AS family,
       vlan,
       gwcount,
       nettype,
       netident,
       orgid AS org,
       usageid AS usage,
       description,
       active_ip_cnt as act,
       prefix.prefixid,
       vlan.vlanid
FROM prefix
LEFT JOIN vlan USING (vlanid)
LEFT JOIN (SELECT gwportprefix.prefixid, COUNT(DISTINCT netboxid) AS gwcount
           FROM gwportprefix
           JOIN interface USING (interfaceid)
           JOIN netbox USING (netboxid)
           WHERE catid IN ('GSW', 'GW')
           GROUP BY gwportprefix.prefixid) tempaggr1 USING (prefixid)
LEFT JOIN prefix_active_ip_cnt USING (prefixid)
";
$title = "Prefixes";
$order_by="network";
$name_m="Mask";
$name_act="Active IPs";
$hide = "netaddr,prefixid,vlanid";
$url_gwcount="gwip?vlanid=$vlanid";
$url_vlan="swporttrunk?vlan=$vlan";
$url_orgid="org?orgid=$orgid";
$url_usageid="usage?usageid=$usageid";
$url_act="/machinetracker/ip?prefixid=$prefixid&days=-1";
$url_nettype="prefix?nettype=$nettype";
$explain_m="Mask of subnet";
$explain_act="No of currently active IP addresses";
$explain_gwcount="No of gateways connected";
$explain_family="IP address family";
$sum="act";
}


# ---------------------------------------------------------------------
# switch port related reports
#

swport {
$description = "List of switch ports and related information about them.";
$sql="
 SELECT 
   local_box.sysname,
   local_interface.ifindex,
   local_interface.ifname AS interface,
   local_module.moduleid,
   local_module.module AS moduleno,
   local_module.name as module,
   local_interface.baseport AS port,
   local_interface.link,
   local_interface.speed,
   local_interface.duplex,
   local_interface.media,
   CASE WHEN local_interface.trunk THEN 'Y' ELSE '' END as trunk, 
   CASE WHEN local_interface.trunk THEN 'see list' ELSE '' END AS allowvlan, 
   CASE WHEN vlan.vlan IS NOT NULL THEN vlan.vlan ELSE local_interface.vlan END AS vlan,
   CASE WHEN vlan.vlan IS NOT NULL THEN 'Y' ELSE '' END AS derived,
   local_interface.ifalias AS alias,
   remote_box.sysname AS to_netboxid,
   remote_interface.ifname AS remote_interface, 
   local_interface.interfaceid,
   local_box.netboxid AS netboxid, 
   local_box.catid 
 FROM 
   interface_swport AS local_interface
 JOIN 
   netbox AS local_box ON (local_interface.netboxid=local_box.netboxid)
 LEFT JOIN 
   module AS local_module USING (moduleid)
 LEFT JOIN 
   netbox AS remote_box ON (to_netboxid=remote_box.netboxid)
 LEFT JOIN 
   swportvlan ON (local_interface.interfaceid=swportvlan.interfaceid AND (trunk=false OR trunk IS NULL))
 LEFT JOIN 
   vlan using(vlanid)
 LEFT JOIN 
   interface AS remote_interface ON (local_interface.to_interfaceid=remote_interface.interfaceid)
";
$title="Switch ports";
$hide = "moduleno,interfaceid,netboxid,moduleid,catid";
$name_sysname = "Switch";
$name_to_netboxid = "Connected to";
$name_remote_interface="Remote if";
$name_speed = "Mbps";
$name_portname = "Description";
$order_by="sysname,moduleno,module,port,ifindex";
$url_sysname="netbox?sysname=$sysname";
$url_module="modules?sysname=$sysname&mn=$module";
$url_port="/machinetracker/swp?switch=$sysname&module=$module&port=$interface";
$url_netboxid="netbox?netboxid=$netboxid";
$url_trunk="swporttrunk?interfaceid=$interfaceid";
$url_allowvlan="allowedvlan?interfaceid=$interfaceid";
$url_vlan="prefix?vlan=$vlan";
$url_to_netboxid="netbox?sysname=$to_netboxid";
$url_remote_interface="swport?sysname=$to_netboxid&interface=$remote_interface";
$explain_to_netboxid="Netbox connected";
$explain_remote_interface="Interface on connected netbox";
$explain_derived="VLAN derived by topology";
$explain_Description="ifAlias or similar description";
}


allowedvlan {
$description = "Allowed VLANs on a switch port.";
$sql="
  SELECT 
    allowedvlan_both.interfaceid, 
    sysname, 
    module.name AS module, 
    ifname AS interface, 
    allowedvlan 
  FROM allowedvlan_both
  JOIN interface ON (interface.interfaceid=allowedvlan_both.interfaceid2) 
  JOIN netbox USING (netboxid)
  LEFT JOIN module USING (moduleid) 
";
$hide = "interfaceid";
$title="Allowed VLANs on switch port";
$order_by="allowedvlan";
$url_sysname="swport?sysname=$sysname";
$url_interface="swport?sysname=$sysname&interfaceid=$interfaceid";
}


swporttrunk {
$description = "Switch ports with trunk ports expanded.";
$sql="
 SELECT 
   local_box.sysname,
   local_interface.ifindex,
   local_interface.ifname AS interface,
   local_module.moduleid,
   local_module.module AS moduleno,
   local_module.name as module,
   local_interface.baseport AS port,
   local_interface.link,
   local_interface.speed,
   local_interface.duplex,
   local_interface.media,
   CASE 
     WHEN local_interface.trunk THEN 'Y' 
     ELSE '' 
   END as trunk, 
   vlan.vlanid,
   vlan.vlan,
   CASE direction
     WHEN 'o' THEN 'Up'
     WHEN 'n' THEN 'Down'
     ELSE 'N/A'
   END AS direction,
   local_interface.ifalias AS alias,
   remote_box.sysname AS to_netboxid,
   remote_interface.ifname AS remote_interface, 
   local_interface.interfaceid,
   local_box.netboxid AS netboxid, 
   local_box.catid 
 FROM 
   interface_swport AS local_interface
 JOIN 
   netbox AS local_box ON (local_interface.netboxid=local_box.netboxid)
 LEFT JOIN 
   module AS local_module USING (moduleid)
 LEFT JOIN 
   netbox AS remote_box ON (to_netboxid=remote_box.netboxid)
 LEFT JOIN 
   swportvlan ON (local_interface.interfaceid=swportvlan.interfaceid)
 LEFT JOIN 
   vlan USING (vlanid)
 LEFT JOIN 
   interface AS remote_interface ON (local_interface.to_interfaceid=remote_interface.interfaceid)
";
$title="Switch ports with trunk ports expanded";
$hide = "moduleno,moduleid,ifindex,interfaceid,netboxid,catid,vlanid";
$name_sysname = "Switch";
$name_to_netboxid = "Connected to";
$name_remote_interface="Remote if";
$name_speed = "Mbps";
$name_alias = "Description";
$order_by="sysname,ifindex";
$url_sysname="netbox?sysname=$sysname";
$url_module="modules?sysname=$sysname&module=$module";
$url_interface="/machinetracker/swp?switch=$sysname&module=$module&port=$interface";
$url_netboxid="netbox?netboxid=$netboxid";
$url_trunk="swporttrunk?interfaceid=$interfaceid";
$url_vlan="prefix?vlan=$vlan";
$url_to_netboxid="netbox?sysname=$to_netboxid";
$url_remote_interface="swport?sysname=$to_netboxid&interface=$remote_interface";
$explain_to_netboxid="Netbox connected";
$explain_remote_interface="Interface on connected netbox";
$explain_Description="ifAlias or similar description";
}


topowalk {
$description = "N/A";
$sql="
  SELECT b1.sysname,m1.module AS module1,s1.port AS port1,b2.sysname AS tonetboxid,
    m2.module AS module2,s2.port AS port2 
  FROM swport AS s1 
  INNER JOIN module AS m1 USING (moduleid) 
  JOIN netbox AS b1 USING (netboxid) 
  JOIN netbox AS b2 ON (to_netboxid=b2.netboxid) 
  LEFT JOIN swport AS s2 ON (s1.to_swportid=s2.swportid) 
  LEFT JOIN module as m2 on s2.moduleid=m2.moduleid";
$extra="swbak,gwbak";
$url_gwbak="topowalkgw?sysname=$tonetboxid";
$url_swbak="topowalk?sysname=$tonetboxid";
}


topowalkgw {
$description = "N/A";
$sql="
 SELECT b1.sysname, gwport.interface,b2.sysname AS to_netboxid,module,s2.port 
 FROM gwport 
 JOIN module USING (moduleid) 
 JOIN netbox AS b1 USING (netboxid) 
 JOIN netbox AS b2 ON (to_netboxid=b2.netboxid) 
 LEFT JOIN swport AS s2 ON (gwport.to_swportid=s2.swportid)";
$title = "Router topology";
$order_by="sysname,interface";
$extra="swbak,gwbak";
$url_sysname="netbox?sysname=$sysname";
$url_to_netboxid="netbox?sysname=$to_netboxid";
$url_gwbak="topowalkgw?sysname=$to_netboxid";
$url_swbak="topowalk?sysname=$to_netboxid";
}


# ---------------------------------------------------------------------
# room,sted,type
#

room {
$description = "Information about rooms.";
$sql="
  SELECT roomid,count(netboxid) AS nb,locationid,descr,opt1,opt2,opt3,opt4 
  FROM room 
  LEFT JOIN netbox USING (roomid)
  GROUP BY roomid,locationid,descr,opt1,opt2,opt3,opt4";
$title = "Room";
$name_roomid="Room";
$name_nb="IP Devices";
$name_locationid="Location";
$name_descr="Description";
$explain_devices="Number of registered IP devices in this room";
$order_by="roomid";
$url_nb="netbox?roomid=$roomid";
$url_locationid="location?locationid=$locationid";
}


location {
$description = "Short info about a location; name, number of rooms and a description.";
$sql="
  SELECT locationid,count(roomid) AS rooms,location.descr
  FROM location 
  LEFT JOIN room USING (locationid) 
  GROUP BY locationid,location.descr";
$title = "Locations";
$order_by="locationid";
$name_locationid="Location";
$name_descr="Description";
$url_rooms="room?locationid=$locationid";
}


type {
$description = "List of product models and the numer of IP addresses and modules related to them.";
$sql="
  SELECT vendorid,typename,count(distinct netboxid) AS ipcount,
    count(moduleid) AS modcount,typeid,type.descr,sysobjectid 
  FROM type 
  LEFT JOIN netbox USING (typeid) 
  LEFT JOIN module USING (netboxid) 
  GROUP by type.typename,vendorid,typeid,type.descr,sysobjectid HAVING count(netbox)>0";
$title = "Types of equipment";
$name_typename="Type";
$name_vendorid="Vendor";
$name_descr="Description";
$order_by="vendorid,typename";
$hide = "typeid";
$url_vendorid="vendor?vendorid=$vendorid";
$url_ipcount="netbox?typeid=$typeid";     
$url_modcount="modules?typeid=$typeid";
$explain_ipcount="Number of IP addresses related to this type";
$explain_modcount="Number of modules related to this type";
}


vendor {
$description = "List of vendors and the number of IP addresses and modules related to them.";
$sql = "
  SELECT vendorid,count(distinct netboxid) AS ipcount,count(moduleid) AS modcount
  FROM module 
  RIGHT JOIN netbox USING (netboxid) 
  JOIN type USING (typeid) 
  RIGHT JOIN vendor USING (vendorid) 
  GROUP BY vendorid 
  ORDER by vendorid";
$title = "Vendors";
$name_vendorid="Vendor";
$explain_ipcount="Number of IP addresses related to this vendor";
$explain_modcount="Number of modules related to this vendor";
$url_vendorid="type?vendorid=$vendorid";
$url_ipcount="netbox?vendorid=$vendorid";
}




# ---------------------------------------------------------------------
# usage,org
#

usage {
$description = "List of how many networks different groups of users uses.";
$sql="
  SELECT usageid,count(prefixid) AS netcount,descr 
  FROM usage 
  LEFT JOIN vlan USING (usageid) 
  LEFT JOIN prefix USING (vlanid) 
  GROUP BY usageid,descr";    
$title = "Usage";
$name_netcount = "Number of networks";
$name_usageid="Usage"; 
$name_descr="Description";
$order_by="usageid";
$url_netcount="prefix?usageid=$usageid";
}


org {
$description = "List of number of networks the different organisational units uses.";
$sql = "
  SELECT orgid,count(prefixid) AS netcount,parent,descr,opt1,opt2,opt3
  FROM org 
  LEFT JOIN vlan USING (orgid) 
  LEFT JOIN prefix USING (vlanid) 
  GROUP BY orgid,parent,descr,opt1,opt2,opt3";
$title = "Organisation";
$name_descr="Description";
$name_parent="Parent";
$name_orgid="Organisational unit";
$order_by="orgid";
$url_parent="org?parent=$parent";
$url_netcount="prefix?orgid=$orgid";
}


# ---------------------------------------------------------------------
# other reports
#

netboxsnmpoid {
$description = "List of netboxes SNMP OID support.";
$sql="
  SELECT sysname,oidkey,snmpoid,mib,oidname,descr AS Description,netboxid,frequency 
  FROM netbox 
  JOIN netboxsnmpoid USING (netboxid) 
  JOIN snmpoid USING (snmpoidid)";
$title="IP Device SNMP OID support";
$hide="netboxid";
$order_by="sysname,oidkey,snmpoid";
$url_sysname="netbox?sysname=$sysname";
$url_oidkey="netboxsnmpoid?oidkey=$oidkey";
$name_frequency="interval";
$explain_interval="Interval between collection, in seconds";
}


#############################
#
# spanning tree blocked
stpblock {
$description = "Lists ports that are blocked by the spanning tree protocol.";
$sql = "
  SELECT swportblocked.vlan,sysname,ifname,baseport,ifindex,link,ifalias AS description
  FROM swportblocked
  JOIN interface_swport USING (interfaceid)
  JOIN netbox USING (netboxid)
  WHERE link='y'";
$order_by="vlan,sysname,baseport,ifindex";
$title = "STP blocked ports";
$hide = "baseport,ifindex";
}


# So far, this thing is just for debugging.  The report generator cannot
# handle searching in a report when the query contains an SQL UNION.
interfaces {
$description = "This report is for debugging purposes, the report generator cannot handle searching in a report when the query contains an SQL UNION.";
$sql = "
   SELECT n.sysname, p.ifindex, p.interface, p.speed, 'swport' as kind, p.moduleid
   FROM swport AS p
   JOIN module AS m USING (moduleid)
   JOIN netbox AS n USING (netboxid)
  UNION
   SELECT n.sysname, p.ifindex, p.interface, p.speed, 'gwport' as kind, p.moduleid
   FROM gwport AS p
   JOIN module AS m USING (moduleid)
   JOIN netbox AS n USING (netboxid)
   ";
$title = "Interfaces";
$hide = "moduleid";
$order_by = "sysname,ifindex";
}


unrecognizedCDP {
$description = "Discovered CDP neighbors that aren't known/monitored by NAV.";
$sql = "
SELECT
  sysname,
  var AS ifindex,
  interface,
  portname AS Description,
  val AS name
FROM netboxinfo ni
JOIN netbox USING (netboxid)
LEFT JOIN (SELECT netboxid, ifindex, interface, portname
           FROM module
           JOIN swport USING (moduleid)
           UNION
           SELECT netboxid, ifindex, interface, portname
           FROM module
           JOIN gwport USING (moduleid)) ports ON (ni.netboxid=ports.netboxid AND ni.var=ports.ifindex::text)
WHERE ni.key='unrecognizedCDP'
";
$order_by="sysname, ifindex";
$title="Unrecognized CDP entries";
$url_sysname="netbox?sysname=$sysname";
$url_name="/ipinfo?ip=$name";
$name_sysname="Reported by (sysname)"
$name_name="Unrecognized name";
}

duplexmismatch {
$title = "Duplex mismatch";
$description = "Lists duplex mismatches on connected switch ports";
$sql = "
SELECT
  n1.sysname AS sysname1, 
  s1.interface AS interface1,
  CASE s1.duplex
    WHEN 'h' THEN 'Half' 
    WHEN 'f' THEN 'Full'
    ELSE 'N/A'
  END AS duplex1,
  CASE s2.duplex 
    WHEN 'h' THEN 'Half' 
    WHEN 'f' THEN 'Full'
    ELSE 'N/A'
  END AS duplex2,
  s2.interface AS interface2,
  n2.sysname AS sysname2
FROM 
  swport s1 
JOIN 
  swport s2 ON (s1.to_swportid=s2.swportid AND 
                s1.duplex <> s2.duplex)
JOIN
  module m1 ON (s1.moduleid=m1.moduleid)
JOIN
  netbox n1 ON (m1.netboxid=n1.netboxid)
JOIN
  module m2 ON (s2.moduleid=m2.moduleid)
JOIN
  netbox n2 ON (m2.netboxid=n2.netboxid)
";
$order_by = "sysname1";
$url_sysname1="netbox?sysname=$sysname1";
$url_sysname2="netbox?sysname=$sysname2";
}

availability_month {
$title = "Availability last month";
$description = "Availability and downtime summary for the last month";
$sql = "
SELECT 
  netboxid,
  sysname,
  SUM(downtime) AS downtime_sum,
  COUNT(alerthistid) AS downperiod_count,

  (1 - (EXTRACT(EPOCH FROM SUM(downtime)) / 
        EXTRACT(EPOCH FROM (global_end-global_start)))
  ) * 100 AS availability_pct,
  global_start::DATE AS from_date
  
FROM (

  SELECT 
    alerthistid,
    netbox.netboxid,
    sysname,
    global_start,
    global_end,
    LEAST(end_time, global_end) - GREATEST(start_time, global_start) AS downtime

  FROM alerthist ah

  JOIN 
    (SELECT 
       now()-interval '1 month' AS global_start, 
       now() as global_end) AS timeslot
    ON (ah.start_time, ah.end_time) OVERLAPS (timeslot.global_start, timeslot.global_end)
  JOIN 
    netbox USING (netboxid)
  WHERE 
    eventtypeid = 'boxState' AND 
    end_time IS NOT NULL AND
    alerttypeid = (SELECT alerttypeid FROM alerttype WHERE alerttype='boxDown')
  ORDER BY 
    sysname, 
    alerthistid

) AS downtime
GROUP BY
  netboxid, sysname, global_start, global_end
";
$order_by = "downtime_sum DESC";
$hide="netboxid,from_date";
$url_sysname = "/ipdevinfo/$sysname";
$url_downperiod_count = "/devicehistory/history/?from_date=$from_date&amp;netbox=$netboxid"
$name_sysname = "Sysname";
$name_downtime_sum = "Total downtime";
$name_downperiod_count = "Incidents count";
$name_availability_pct = "% available";
}

topology_candidates {
$title = "Direct neighborship candidates";
$description = "Candidates for direct neighborship, evaluated during topology derivation";
$sql="
SELECT
  frombox.sysname AS from_device, fromport.ifname as from_interface, 
  tobox.sysname AS to_device, toport.ifname as to_interface,
  CASE toportbox.netboxid = tobox.netboxid
    WHEN True THEN NULL
    ELSE toportbox.sysname
  END AS control
FROM
  swp_netbox AS sn
JOIN
  netbox frombox ON (sn.netboxid=frombox.netboxid)
JOIN
  interface fromport ON (sn.netboxid=fromport.netboxid AND sn.ifindex=fromport.ifindex)
JOIN
  netbox tobox ON (sn.to_netboxid = tobox.netboxid)
LEFT JOIN
  interface toport ON (sn.to_interfaceid = toport.interfaceid)
LEFT JOIN
  netbox toportbox ON (toport.netboxid=toportbox.netboxid)
ORDER BY
  from_device, sn.ifindex, to_device, to_interface
";
$name_from_device="Sysname";
$url_from_device="/ipdevinfo/$from_device";

$name_from_interface="Interface";
$url_from_interface="/ipdevinfo/$from_device/interface=$from_interface";

$name_to_device="Candidate neighbor";
$url_to_device="/ipdevinfo/$to_device";

$name_to_interface="Candidate neighbor port";
$url_to_interface="/ipdevinfo/$to_device/interface=$to_interface";

$explain_control="This column should be empty, or something is wrong with the topology system";
}

offline_devices {
$title = "Offline devices";
$description = "These are devices that have been shelved, but are known to NAV";
$sql = "
SELECT
  serial, 
  COALESCE(to_char(discovered, 'YYYY-MM-DDÂ HH24:MI:SS'), 'N/A') AS firstseen,
  hw_ver, fw_ver, sw_ver, 
  COALESCE(discovered, '1970-01-01 00:00:00'::timestamp) AS discovered
FROM
  device
WHERE 
  serial IS NOT NULL AND serial <> '' AND
  deviceid NOT IN (SELECT deviceid FROM netbox WHERE deviceid IS NOT NULL
                   UNION
                   SELECT deviceid FROM module WHERE deviceid IS NOT NULL)
ORDER BY discovered DESC

";

$name_serial = "Serial #";
$name_hw_ver = "HW version";
$name_fw_ver = "FW version";
$name_sw_ver = "SW version";
$name_firstseen = "First seen by NAV";
$hide = "discovered";

}

#
# EOF
#
